services:
  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-rta-camera}_db
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-rta_camera_db}
      POSTGRES_USER: ${DATABASE_USER:-admin}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-secretpassword}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-admin} -d ${DATABASE_NAME:-rta_camera_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: ${DB_MEMORY_LIMIT:-1G}
          cpus: '${DB_CPU_LIMIT:-0.5}'

  # Backend API (FastAPI + Uvicorn)
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-rta-camera}_backend
    environment:
      - DATABASE_URL=postgresql://${DATABASE_USER:-admin}:${DATABASE_PASSWORD:-secretpassword}@db:5432/${DATABASE_NAME:-rta_camera_db}
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key}
      - ALGORITHM=${ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - DEBUG=${DEBUG:-True}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis123}@redis:6379/0
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: ${BACKEND_MEMORY_LIMIT:-2G}
          cpus: '${BACKEND_CPU_LIMIT:-1.0}'

  # Frontend (React) - Only when ENABLE_FRONTEND=true
  frontend:
    build:
      context: ./frontend
      dockerfile: ${FRONTEND_DOCKERFILE:-Dockerfile.prod}
    container_name: ${COMPOSE_PROJECT_NAME:-rta-camera}_frontend
    ports:
      - "${FRONTEND_PORT:-3000}:${FRONTEND_INTERNAL_PORT:-80}"
    depends_on:
      - backend
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${FRONTEND_INTERNAL_PORT:-80}"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: ${FRONTEND_MEMORY_LIMIT:-512M}
          cpus: '${FRONTEND_CPU_LIMIT:-0.5}'
    profiles:
      - ${ENABLE_FRONTEND:-production}

  # Nginx Reverse Proxy - Only when ENABLE_NGINX=true
  nginx:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-rta-camera}_nginx
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - backend
      - frontend
    restart: ${RESTART_POLICY:-unless-stopped}
    deploy:
      resources:
        limits:
          memory: ${NGINX_MEMORY_LIMIT:-256M}
          cpus: '${NGINX_CPU_LIMIT:-0.25}'
    profiles:
      - ${ENABLE_NGINX:-production}

  # Redis for Caching - Only when ENABLE_REDIS=true
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-rta-camera}_redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis123}
    volumes:
      - redis_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    restart: ${RESTART_POLICY:-unless-stopped}
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT:-512M}
          cpus: '${REDIS_CPU_LIMIT:-0.25}'
    profiles:
      - ${ENABLE_REDIS:-production}

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    name: ${NETWORK_NAME:-rta_camera_network}